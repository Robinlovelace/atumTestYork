---
format: gfm
# format: html
---

```{r}
#| include: false
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
```

The aim of this repo is to showcase ways of generating evidence to support strategic active network planning tools in England and beyond.

The intention is to provide language agnostic description of input datasets processes and functions for generating estimates of active travel uptake down to the street level.
It will make use of some of the same input datasets that are used in the Propensity to Cycle Tool (PCT).
For full reproducibility, the code in this repo is developed in a Docker container using the [.devcontainer.json](https://containers.dev/implementors/json_reference/) format.

We will cover input datasets, processing steps, and outputs.

# Input datasets

The input datasets were extracted from the Propensity to Cycle Tool and underlying datasets.
Small input datasets are saved in the `input/` folder of this repo.

```{r}
remotes::install_cran("pct")
```

## Zone data

Zone data is available at many geographic levels, including large zones (e.g. MSOAs) and small zones (e.g. Output Areas).
MSOAs representing York are shown below.

```{r}
zones = pct::get_pct_zones(region = "north-yorkshire", geography = "msoa")
zones = zones |>
  filter(lad_name == "York")
zones |>
  transmute(active_trips = bicycle + foot) |>
  plot()
```

```{r}
#| echo: false
#| eval: false
sf::write_sf(zones, "input/zones.geojson")
```


## Origin destination data

OD data has the following structure:

```{r}
#| echo: false
#| eval: false
if(file.exists("od_national.csv")) {
    od_national = readr::read_csv("od_national.csv")
} else {
    od_national = pct::get_od()
    readr::write_csv(od_national, "od_national.csv")
}
od_york = od_national |>
  filter(geo_code1 %in% zones$geo_code) |>
  filter(geo_code2 %in% zones$geo_code)
write_csv(od_york, "input/od.csv")
```


```{r}
od_york = read_csv("input/od.csv")
od_york |>
  slice(seq(10)) |>
  knitr::kable()
```

This dataset was extracted from the following open access endpoint: https://s3-eu-west-1.amazonaws.com/statistics.digitalresources.jisc.ac.uk/dkan/files/FLOW/wu03ew_v2/wu03ew_v2.zip


## Data on origins and destinations

A key dataset type for simulating trips not covered by available OD data is data on trip origins (e.g. representing residential areas and population estimates) and 'trip attractors'.
These can be obtained from OSM.
These datasets typically have pont and polygon geometries and numerous features that can feed into trip generation models, a subsection of the enxt section.

# Processing steps

## Desire line generation

## Trip generation

## Jittering

## Routing

## Update functions

## Route network generation

## Visualisation

# Outputs

